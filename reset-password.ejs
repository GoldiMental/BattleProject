<!DOCTYPE html>
<html lang="de">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Passwort zurücksetzen - TulpaKing®</title>
    <link rel="stylesheet" href="Style/login.css">
</head>

<body>
    <!--Background-Section-Beginning-->
    <div class="background-lines">
        <div class="lineRed line-1"></div>
        <div class="lineGold line-2"></div>
        <div class="lineRed line-3"></div>
        <div class="lineGold line-4"></div>
        <div class="lineRed line-5"></div>
        <div class="lineGold line-6"></div>
        <div class="lineRed line-7"></div>
        <div class="lineGold line-8"></div>
        <div class="lineRed line-9"></div>
        <div class="lineGold line-10"></div>
    </div>
    <img id="TulpaIcon" src="img/TulpaIcon.png" alt="TulpaKing-Logo">
    <!--Background-Section-Ending-->
    <div class="main-container">
        <div class="TulpaKingTitle">TulpaKing®</div>
        <div class="login-container">
            <h2 class="title-text">Neues Passwort festlegen</h2>
            <div id="message-container"></div>
            <form id="reset-password-form">
                <input type="password" id="new-password" placeholder="Neues Passwort" required>
                <input type="password" id="confirm-password" placeholder="Passwort bestätigen" required>
                <button type="submit">Passwort ändern</button>
            </form><br>
            <a href="<%= gameServerIP %>" class="back-link">Zurück zur Anmeldung</a>
        </div>
    </div>
    <script language="JavaScript">
        const GAME_SERVER_IP = '<%= gameServerIP %>';
        document.addEventListener('DOMContentLoaded', () => {
            const resetPasswordForm = document.getElementById('reset-password-form');
            if (resetPasswordForm) {
                resetPasswordForm.addEventListener('submit', async (e) => {
                    e.preventDefault();

                    const urlParams = new URLSearchParams(window.location.search);
                    const token = urlParams.get('token');
                    const newPassword = document.getElementById('new-password').value;
                    const confirmPassword = document.getElementById('confirm-password').value;
                    const messageContainer = document.getElementById('message-container');

                    if (newPassword !== confirmPassword) {
                        messageContainer.textContent = 'Passwörter stimmen nicht überein!';
                        messageContainer.className = 'error-message';
                        return;
                    }

                    if (!token) {
                        messageContainer.textContent = 'Ungültiger oder fehlender Token!';
                        messageContainer.className = 'error-message';
                        return;
                    }

                    try {
                        let link = GAME_SERVER_IP + "/reset-password";
                        const response = await fetch(link, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({ token, newPassword })
                        });

                        const data = await response.json();
                        messageContainer.textContent = data.message;
                        if (response.ok) {
                            messageContainer.className = 'success-message';
                        } else {
                            messageContainer.className = 'error-message';
                        }

                    } catch (error) {
                        console.error('Fehler:', error);
                        messageContainer.textContent = 'Ein Fehler ist aufgetreten. Bitte versuche es später erneut.';
                        messageContainer.className = 'error-message';
                    }
                });
            }
        });
    </script>
</body>

</html>